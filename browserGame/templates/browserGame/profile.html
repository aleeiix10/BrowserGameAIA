{% extends 'base.html' %}
{% load static %}
{% load render_bundle from webpack_loader %}
{% block title %} Perfil {% endblock %}
{% block content %}
<body class="bg-green-300">
    <header class="bg-green-700 text-white py-2">
        <div class="container mx-auto flex justify-between items-center px-4">
            <h1 class="text-xl">Dashboard {{user}}</h1>
            <a href="/accounts/logout/" class="underline">Logout</a>
        </div>
    </header>

    <main class="container mx-auto my-4">
        <h2 class="text-lg font-semibold mb-2">Informació personal usuari</h2>
        <table class="border border-black">
            <thead class="bg-green-700 text-white text-center">
                <tr>
                    <th class="p-2">
                        Nivell
                    </th>
                    <th class="p-2">
                        Vida
                    </th>
                    <th class="p-2">
                        Manà
                    </th>
                    <th class="p-2">
                        Experiència
                    </th>
                </tr>
            </thead>
            <tbody>
                <tr class="border-b border-black text-center" id="profileStats">
                    <td class="p-2" id="profileStatsLevel">

                    </td>
                    <td class="p-2" id="profileStatsLife">

                    </td>
                    <td class="p-2" id="profileStatsMana">

                    </td>
                    <td class="p-2" id="profileStatsExperience">

                    </td>
                </tr>
            </tbody>
        </table>
        {% if userLoged|length >= 1 %}
        <h2 class="text-lg font-semibold mt-4 mb-2">Últimes 30 accions realitzades</h2>
        <table class="border border-black">
            <thead class="bg-green-700 text-white text-center">
                <tr>
                    <th class="p-2">
                        Agressor
                    </th>
                    <th class="p-2">
                        Victima
                    </th>
                    <th class="p-2">
                        Nom Acció
                    </th>
                    <th class="p-2">
                        Categoria
                    </th>
                    <th class="p-2">
                        Moment Acció
                    </th>
                    <th class="p-2">
                        Cost
                    </th>
                    <th class="p-2">
                        Èxit
                    </th>
                </tr>
            </thead>
            <tbody id="tbodyRelatedActions">
            </tbody>
        </table>
        {% endif %}
    </main>
    <script>
        $(document).ready(function(){
            setInterval(getStats, 30000);
            setInterval(getRelatedActions, 30000);
            function getStats() {
                $.getJSON("api/get_users",async function(usuari){
                    $('#profileStatsLevel').text(usuari.UsersObj[0].level);
                    $('#profileStatsLife').text(usuari.UsersObj[0].current_life);
                    $('#profileStatsMana').text(usuari.UsersObj[0].current_mana);
                    $('#profileStatsExperience').text(usuari.UsersObj[0].experience);  
                });
            }
            function getRelatedActions() {
                $.getJSON("api/get_related_actions",async function(actions){
                    $('#tbodyRelatedActions').empty();
                    actions.ActionsObj.forEach(action =>{

                    $('#tbodyRelatedActions').append('<tr class="border-b border-black text-center">');
                    if (action.user__username == null){
                        $('#tbodyRelatedActions').append(`<td class="p-2">     </td>`);
                    }else{
                        $('#tbodyRelatedActions').append(`<td class="p-2">`+action.user__username+`</td>`);
                    }
                    if (action.user_attacked__username == null){
                        $('#tbodyRelatedActions').append(`<td class="p-2">     </td>`);
                    }else{
                        $('#tbodyRelatedActions').append(`<td class="p-2">`+action.user__username+`</td>`);
                    }
                    $('#tbodyRelatedActions').append(`<td class="p-2">`+action.action__name+`</td>`);
                    if (action.action__category =='A'){
                        $('#tbodyRelatedActions').append(`<td class="p-2">Agressiva</td>`);
                    }else if (action.action__category == 'D'){
                        $('#tbodyRelatedActions').append(`<td class="p-2">Defensiva</td>`);
                    }else{
                        $('#tbodyRelatedActions').append(`<td class="p-2">Neutral</td>`);
                    }
                    $('#tbodyRelatedActions').append(`<td class="p-2">`+action.timestamp+`</td>`);
                    $('#tbodyRelatedActions').append(`<td class="p-2">`+action.action__cost+`</td>`);

                    if (action.success == false){
                        $('#tbodyRelatedActions').append(` <td class="p-2"><i class="fa fa-sharp fa-solid fa-circle-xmark" style="color: #a73131;"></i></td>`);
                    }else{
                        $('#tbodyRelatedActions').append(`<td class="p-2"><i class="fa fa-solid fa-circle-check" style="color: #316e32;"></i></td>`);
                    }
                    $('#tbodyRelatedActions').append(`</tr>`);
                    })
                });
            }
            getStats();
            getRelatedActions();
        });
    </script>
</body>
{% endblock %}
